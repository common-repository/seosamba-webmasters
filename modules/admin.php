<?php
/**
 * Created by Oleg Malii
 * Date: 21.03.17 11:11
 */
class SeosfwmAdmin extends SeosambaWebmasters {

    const NEWS_SITEMAP_XML = 'https://www.seosamba.com/sitemapnews.xml';

    public function __construct() {
        parent::__construct();
    }

    const SVG_IMAGE = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMTUwIDE1MCI+ICA8ZGVmcz4gICAgPHN0eWxlPiAgICAgIC5jbHMtMSB7ICAgICAgICBmaWxsOiAjNDk0OTRiOyAgICAgICAgZmlsbC1ydWxlOiBldmVub2RkOyAgICAgIH0gICAgPC9zdHlsZT4gIDwvZGVmcz4gIDxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTc0Ljk1OCwyLjM4MmMzOC40NjktLjUzNiw3My4xOTIsMzEuMDE0LDcyLjcwOSw3My41MzFBNzIuMzYyLDcyLjM2MiwwLDAsMSw3NC4xLDE0Ny42MjFjLTQxLjE4LS40NDUtNzIuMy0zNC40MzQtNzEuNzY2LTczLjcyOEMyLjg3MywzNC40NTYsMzUuNTEzLDEuOTYsNzQuOTU4LDIuMzgyWk05LjcyOCw3NC42NzVDOS4yNDUsMzkuODEyLDM4LjE2OCw5LjE0OCw3NS40NzQsOS4yNzRjMzUuNjE5LDAuMTIxLDY1LjAyOCwyOS42ODEsNjQuOTQ2LDY1LjVhNjUuNDg2LDY1LjQ4NiwwLDAsMS02NS41NjgsNjUuMjQ2QzM4Ljc0NCwxNDAuMDkzLDkuMjcxLDExMC4wNDIsOS43MjgsNzQuNjc1Wm0yLjg0Mi0uMDM1YTYyLjQ3OCw2Mi40NzgsMCwxLDEsNjEuMDUyLDYyLjUzMUMzOS43NDksMTM2LjQ2OSwxMi4zNDYsMTA4LjU3LDEyLjU3MSw3NC42NFptMy4wNjUsMC4wMjZjLTAuNDgzLTMxLjMxNywyNS4zOTQtNTkuNSw1OS40OC01OS40NDJhNTkuNDI4LDU5LjQyOCwwLDEsMS0uODIyLDExOC44NTNDNDAuODUyLDEzMy43LDE1LjE3MiwxMDUuOSwxNS42MzYsNzQuNjY2Wm00Ni45LTIyLjIyNWE0Mi4yMjksNDIuMjI5LDAsMCwwLTMuMzc2LDUuOTM3Yy0wLjgyNCwyLjE2MSwwLDMuOTA3LDIuMDk0LDQuOUE1OC41NTcsNTguNTU3LDAsMCwwLDY3LjUsNjUuNDU3bDIuMzIzLDAuMDExLTIuMDk0LS42MTZzLTIuMTgxLS44NjYtMy4yMzMtMS4zNzdjLTMuNjctMS43NzktNC40LTQuMjYzLTIuMTMxLTcuNjc4YTExLjYxOSwxMS42MTksMCwwLDEsOS40MjItNS4yMjRjMy4zODQtLjE4OCw2LjguMjA2LDkuOTc0LDAuMzMzLTEuODA2LTEuODQyLTYuMTY2LTIuMzc2LTEzLjk3Mi0xLjQ3MmExMy4yMTksMTMuMjE5LDAsMCwxLDkuOTE5LS42NjdBNi42MjgsNi42MjgsMCwwLDAsODQuNyw0Ni43ODdhOC4zNjEsOC4zNjEsMCwwLDEsMy4yMy0xLjQyLDI3LjM0MywyNy4zNDMsMCwwLDEsMy4wMzMtLjYzMWwwLjYwOCwwLjgsMi43OTItMS4zNDhjMi4xODIsMy4wNDgsNC4zLTEuNDgzLDYuNTA2LjIzMy0wLjEwNi41NS0uMjM4LDEuMjM0LTAuMzQ4LDEuOCwyLjE5LTEuMTE0LDQuMjItMi41MTcsNi40NjgtMy4xODVhMjEuNjM4LDIxLjYzOCwwLDAsMSw3LjA3Ny0uNDgsNDcuOCw0Ny44LDAsMCwwLTUuODE5LDEuMzk0LDEzLjA1LDEzLjA1LDAsMCwwLTMuNjQ0LDIuMzY5Yy0wLjM5Mi4zMjUtLjM0NywxLjE3Ni0wLjUsMS43ODdhNC4zMDgsNC4zMDgsMCwwLDAsMS42MzEtLjQ0NmMzLjUxOS0yLjk0MSw3LjY2LTMuNjM4LDEyLjA1Mi0zLjQ0N2E2Ljc2OCw2Ljc2OCwwLDAsMSw1LjUsMi44MzRjLTYuMzItMi40LTEwLjk0MS0uNDA4LTE0Ljc4NywzLjE2MXEwLjA2MSwwLjMwNy4xMjEsMC42MTRhNi43NTIsNi43NTIsMCwwLDAsMi4yLS41ODEsMTYuNDMsMTYuNDMsMCwwLDEsMTQuMS0xLjc1NmMtNC4zNDEuODMzLTguNjIsMC44LTExLjUzNCw0LjFsMC4xOTIsMC43MjRhNi4wODYsNi4wODYsMCwwLDAsMS43NzQtLjQxLDEzLjI0NSwxMy4yNDUsMCwwLDEsOS4zMzctMS44NjdjLTEuNjc3Ljk4Mi0zLjU3LDItNS4zNSwzLjE5M2EzLjgzMSwzLjgzMSwwLDAsMC0uNywxLjcyLDYuMjg1LDYuMjg1LDAsMCwwLDItLjE0MWMxLjk1Mi0uODE4LDMuODQ3LTEuNzc0LDUuNzYzLTIuNjc3bDAuMywwLjU2MWMtMSwxLjAzNi0yLjA4MSwyLjAxNC0zLDMuMTI0LTEuMjc5LDEuNTUtMS4xMDUsMi4wMDguNzU0LDIuNmE5LjA0NSw5LjA0NSwwLDAsMCwxLjYuNTA4YzQuNzE0LDAuNTQ3LDQuNzQ3LDQuMzY3LDUuMTUsNy42NjYsMS45NDEsMTUuODg3LTEuOTMyLDMwLjIxLTExLjg5Myw0Mi44MTEtMC43NzcuOTgzLTEuNjQzLDEuOS0yLjcwNiwzLjExNmEyNS45MDksMjUuOTA5LDAsMCwxLDIuNjQzLTE1LjcsMTguOSwxOC45LDAsMCwwLTQuMzYxLDkuMjY3Yy0wLjQyNCwyLjMyNy0uMzIxLDQuNzQ2LTAuNTI3LDcuMTE4YTI1LjI2NywyNS4yNjcsMCwwLDEtLjcsMy4wMzFsLTIuMTY5LTMuMTlhMS42LDEuNiwwLDAsMC0uMjE0LjU2NWMxLjcxMSwyLjY5Mi4wNDEsNC4wMy0xLjk2Nyw1LjVhNTcuNTQzLDU3LjU0MywwLDAsMS0yNi40NzEsMTAuNjgyLDI3Ljg1LDI3Ljg1LDAsMCwxLTMuMTUyLjAxNWw3LjE3NC0xMC4zYTIuODI5LDIuODI5LDAsMCwxLTEuNDA5LS43MDZjLTEuMTQxLTEuNTI0LTIuMDUzLTMuMjE2LTMuMTItNC44YTE2LjE0MiwxNi4xNDIsMCwwLDAtMi4wNTgtMi41NzZjLTEuOTA3LTEuODUzLTMuODQ2LTMuNjgyLTUuODg2LTUuMzg0YTYuNzE2LDYuNzE2LDAsMCwwLTIuMzUzLS43NTFsLTAuNTU0LTIuOTc5LTEuOTk0LjctMC45NDktMS4wODlhMC44MzMsMC44MzMsMCwwLDAtLjM2NS4wMDdjLTAuNzgxLDEuNjQ1LTEuNTIxLjQ2OC0yLjE1OS0uMDg4YTQuMzMsNC4zMywwLDAsMS0uNDEtMS4xNThjLTAuMzY1LS43LTAuOC0xLjM1OS0xLjItMi4wMzYtMC42MTIuNDg4LTEuMjI5LDAuOTY5LTEuODMyLDEuNDY4LTAuMTkzLjE1OS0uMzQ3LDAuMzY0LTAuODU5LDAuOTEzLTAuMTQ3LTEuODM5LS4yNi0zLjI1Ny0wLjQyMi01LjI5M2wtMy40LDIuMjk0YzAtLjkuMDMxLTEuNjg1LTAuMDEtMi40NjctMC4wMzEtLjU4NC0wLjAxLTEuNTcyLTAuMjY2LTEuNjYzYTIuNjM3LDIuNjM3LDAsMCwwLTEuOTU1LjE0MywxNS43NywxNS43NywwLDAsMC0yLjM5MSwyLjEzNGMtMC4xLTEuOS0uMTc5LTMuMzY5LTAuMjY1LTQuOTgxYTIuMDc3LDIuMDc3LDAsMCwwLS45NTEtMC4xNDdjLTEuOTA1Ljc3OS0yLjgyMywwLjExMi0zLjIyNC0xLjg1M0M0OC41LDg4LjYxNyw0Ny4xNjYsODguNzQ3LDQ2LDg5LjA0NWExNC4zNDIsMTQuMzQyLDAsMCwwLTIuMzcyLDEuMmwxLjYtMy40MDdjMTEuNDE4LDMuNywyMi41ODUsNy4zNTgsMzMuNzgzLDEwLjkyLDQuMDQ1LDEuMjg2LDguMDkxLDIuNjE5LDExLjIxNiw1LjU2OGE2My4zNTIsNjMuMzUyLDAsMCwxLDUuMjc5LDYuMzQ3LDEyLjg1MSwxMi44NTEsMCwwLDAtNC44MjgtOC4zLDkzLjE0Nyw5My4xNDcsMCwwLDAtOS4zNDYtNmMtMi4yNi0xLjM4OC00LjY5Mi0yLjUxOC02Ljg1Mi00LjA0LTMuNzMzLTIuNjMxLTcuNTIyLTQuOTYtMTIuMzEzLTQuNzUyYTQuODI5LDQuODI5LDAsMCwwLTIuMzQ5LjczMWMyLjI3MSwwLjQzNyw0LjU3Ny43NDQsNi44LDEuMzQ3YTEwLjQ1NCwxMC40NTQsMCwwLDEsNi4wNTMsNC4yMTQsMTcuNzkzLDE3Ljc5MywwLDAsMS0yLjIzNS0uMTU3LDYuMjQ4LDYuMjQ4LDAsMCwxLTEuNzc1LS42MzZBMzMuMDYsMzMuMDYsMCwwLDAsNTQuNTc4LDg3Ljc2Yy01LjE1OC0uNDE3LTkuNDUyLTMuMzMtMTMuMTc0LTYuOTA4YTI3LjA4MywyNy4wODMsMCwwLDEtMy4xMTYtMy4zMzZjLTAuNzk0LTEuMDc4LS41MjMtMi4wNjUsMS4wMS0yLjE4NGE3MC4yNjIsNzAuMjYyLDAsMCwxLDcuNTUzLS40MjdjNy4zLDAuMjIyLDE0LjU5LjU5MSwyMS44ODMsMC45NDMsNC45LDAuMjM3LDguNDU3LTIuNDMzLDExLjc3LTUuNjkxYTE1LjY2NiwxNS42NjYsMCwwLDAtMS42OTMuNzg3Yy01LjM2MywzLjI4OC0xMS4wODcsMy41NjgtMTcuMjQsMi45MzRhMTU1Ljk4NCwxNTUuOTg0LDAsMCwwLTIwLjE1OC0uNDY1Yy00LjM2OS4xMTgtNC44MzYtLjA2OS00Ljg1MS00LjU3NS0wLjAxMS0zLjMuNTg2LTUuOTE1LDQuMTM4LTcuMjM5LDQuOTg1LTEuODU3LDkuODY3LTMuOTkyLDE0Ljc4MS02LjAzNiwyLjM4NC0uOTkyLDQuNzQyLTIuMDQ3LDcuMTExLTMuMDc0Wm0zNy42NSw2Mi4xMTZjLTMuMjQxLjY1My0xMi4xNzYsNS42NjctMTMuMDU4LDguMTg2QzkxLjEzMSwxMTkuNTE3LDk2LjM3NywxMTcuNjI4LDEwMC4xODcsMTE0LjU1N1pNNjIuNTkxLDUyLjQ5bDAuNi0xLjA0MS0wLjMyLS41NzRMNTEuNDQ0LDU1LjUyMUM1NS4yLDUxLjEsNjEuNzIyLDQ4Ljc0NSw2Ni4yLDUwLjMxN2MtMS4yNzcuNzQyLTIuNDY5LDEuNDM0LTMuNjYyLDIuMTI1Wm0zMS41LDEwLjIsMi40NjYsNC4yMjYsMC43LS4xNzhMOTYuNiw1Ny4wNzNhMTMuODk0LDEzLjg5NCwwLDAsMSwyLjM3OSw3Ljc5NCwxMy41NjYsMTMuNTY2LDAsMCwwLDIuODgzLDguNTZjMi43MTQsMy43NDUsMi42NTgsOC4xMjcsMi40NDQsMTIuNDQsMy41NjItMy40MjIsNC4wMzMtNi42MzksMi43NDYtMTkuODc5LDEuOTExLDIuNjgzLDIuMjk0LDUuNDI0LDIuNTI4LDguMTUzYTIyLjY1NiwyMi42NTYsMCwwLDEtNC44MjgsMTYuMTQyLDIzLjYzMywyMy42MzMsMCwwLDAtMi43MTcsNC41OTRjNS4wODQtMy41NjIsMTAuODExLTQuMzA5LDE2LjU2MS00Ljk4MSwwLjA2NywwLjI0Ni4xMzMsMC40OTIsMC4yLDAuNzM4LTIuMDYxLjQ4MS00LjEsMS4wODgtNi4xODgsMS40MjMtMTAuMjE3LDEuNjM5LTE0LjQ2Miw5LjYtMTUuNjYyLDE2Ljk2OC0wLjE4OSwxLjE1OS0uMzkyLDIuMzE1LTAuNjE4LDMuNjUxLTEuMDc0LTIuOTE2LS41OTUtNS44MDksMi4xNS0xMy40OS00LjQ0LjY2NC04LjIxNi0uMjA4LTEwLjYwNy00LjY2OC0xLjk0MiwxLjI2Ni0zLjgxNy43NDYtNS42NDEtLjM2My0yLjI1NC0xLjM3MS0yLjk4NC0zLjExLTEuNTU3LTUuMjc3YTIzLjg4NSwyMy44ODUsMCwwLDEsNS4wMi01LjUxOGMyLjE5NC0xLjczOCwzLjMtMS40MzEsNS4zLjQyNiw1LjE1Ni0zLjYxNiw3LjIyNC0zLjgzNywxMC43OTItMS4yMzZsLTQuMjMtMTIuNjM1Yy0xLjI3MywxLjEtMi4zLDIuNzE4LTMuNDMyLDIuOC0yLjA5My4xNDQtMi42MS0yLjAxNC0zLjExMi0zLjY3Ny0xLjA2My0zLjUyLjI1NS02LjA4OCwzLjEzNi02LjMzWk05My40MDcsNDguNTkzYzcuMzg3LDAuNDgsMTQuMzc2LDIuMTM0LDIwLjAxNCw3LjM1NGE2My4zMyw2My4zMywwLDAsMCw1LjI4Nyw0LjgxMmMxLjgyMiwxLjMzOSwzLjk0MSwyLjI3NSw1Ljk0OCwzLjY5MmE3Ljc2LDcuNzYsMCwwLDEtMi43LS40NDcsNDUuMTM4LDQ1LjEzOCwwLDAsMS03LjE1My00LjcyOEE0Ni45MjMsNDYuOTIzLDAsMCwwLDk1LjU4Miw0OS4yNzFjLTAuMzM3LS4wOTItMC42OC0wLjE2My0xLjAxMy0wLjI2OEM5NC4xNzgsNDguODgsOTMuNzk0LDQ4LjczMSw5My40MDcsNDguNTkzWk01My42LDg1LjY4N2M2LjY4Ny0uMTU3LDEzLjI4LTEuOTIsMTkuNzMyLjIsMC43MTIsMC4yMzMsMS40LjU0NywyLjA5NCwwLjgyNGwwLjA0MiwwLjY3NWMtMC45MTUuMTQ3LTEuOTIxLDAuNjE4LTIuNzI5LDAuMzg5YTUwLjQ2Myw1MC40NjMsMCwwLDAtMTUuNTgtMS40MjZBMTYuNTEsMTYuNTEsMCwwLDEsNTMuNiw4NS42ODdaTTc3LjYzOSw1Ny4wNjJhMy40MTYsMy40MTYsMCwwLDEtMy44LDMuNTMyYy0xLjU2OS0uMDE0LTIuNDY0LTEuNTYzLTIuNDE4LTQuMTg3LDAuMDI1LTEuNDUsMS45NjEtMy4wODEsMy42MTEtMy4wNDNDNzUuOTgzLDUzLjM4Niw3Ny42NzEsNTUuNzc3LDc3LjYzOSw1Ny4wNjJaTTk0LjA5LDYyLjY4NUw5NC4xNDksNjIuN2MtMC45OTQtMi40NDktMi4wNDEtNC44OC0yLjk3My03LjM1NC0xLjEzOS0zLjAyNC0yLjEtNi4xNDktNS44MDgtNy4xNmwwLjIxMy0uNTEzYTYuNDI0LDYuNDI0LDAsMCwxLDIuMzQ0LjUzN2MxLjA1NCwwLjc1LDIuMzU2LDEuNjM5LDIuNzQxLDIuNzUyQzkyLDU0LjgsOTIuOTc2LDU4Ljc2OCw5NC4wOSw2Mi42ODVabS05LjQ2NCwyLjVjMy4zNjgtLjMyNyw0LjQ1NS41MjIsNC43NTQsMy43YTkuMDgzLDkuMDgzLDAsMCwxLS4xOTMsMy42NjFDODguOCw3MS4xMDksODguNyw2OS41LDg3Ljk0Nyw2OC4yODRTODUuODA3LDY2LjI0Niw4NC42MjUsNjUuMTg4Wk02OC4zODIsNTUuMTdjMi4zNTMtNC41MTUsNy44MDgtNC45LDEwLjIyNi0uNjU0Qzc0Ljk1NSw1MS42MzUsNzEuNTg1LDUyLjA1OCw2OC4zODIsNTUuMTdabTguMDY2LDEuNDkxYzAuMTI1LDAuNzE5LS40NjgsMS43NDktMS4xODYsMS40MzdhMi4zMTUsMi4zMTUsMCwwLDEtMS40MTYtMS44MzhjLTAuMDMxLS43ODEuMjE0LTEuMTE1LDAuODctMS4xNDZBMi4xMzgsMi4xMzgsMCwwLDEsNzYuNDQ4LDU2LjY2MVoiLz48L3N2Zz4=";

    public function register_seosamba_menu_page() {

        add_menu_page(
            'Sambapres Dashboard',
            SeosambaWebmasters::COMPANY_NAME,
            'manage_options',
            SeosambaWebmasters::DASHBOARD_LINK,
            'seosfwm_load_dashboard',
            self::SVG_IMAGE
        );
    }

    public function save_access_key() {
        try {
            if (is_admin() && wp_verify_nonce($this->_params['security_field'],self::ACCESS_KEY_FIELD) ) {
                $this->_save_access_key();
                $response = array(
                    'done' => 1,
                    'message' => 'Access key has been updated'
                );
            } else {
                $response = array(
                    'done' => 0,
                    'message' => 'Unauthenticated User'
                );
            }
        } catch (Exception $e) {
            $response = array(
                'done' => 0,
                'message' => $e->getMessage()
            );
        }

        $this->_response($response);
    }

    private  function _save_access_key() {
        global $wpdb;
        $access_key = trim($this->_params[self::ACCESS_KEY_FIELD]);
        $query = "INSERT INTO " . $wpdb->prefix . "options (`option_name`, `option_value`, `autoload`)
                VALUES('" . self::ACCESS_KEY_FIELD . "','%s', 'no') 
                ON DUPLICATE KEY UPDATE option_value = '%s' ";
        $query = $wpdb->prepare($query, $access_key, $access_key);
        return $wpdb->query($query);
    }

    public function get_news() {
        $response = wp_remote_get(self::NEWS_SITEMAP_XML);
        header('Content-type: text/xml');
        echo wp_remote_retrieve_body( $response );
        die();
    }

    protected function _response($response) {
        echo json_encode($response);
        die();
    }
}

function seosfwm_load_dashboard() {
    require_once ('dashboard.php');
    seosfwm_dashboard();
}

$seosfwm_admin = new SeosfwmAdmin();
add_action( 'wp_ajax_seosfwm_save_access_key', array( $seosfwm_admin, 'save_access_key' ) );
add_action( 'wp_ajax_seosfwm_get_news', array( $seosfwm_admin, 'get_news' ) );
?>